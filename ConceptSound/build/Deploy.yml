- pipeline: "Deploy"
  on: "CLICK"
  refs:
    - "refs/heads/develop"
  fail_on_prepare_env_warning: true
  actions:
    - action: "build ionic"
      type: "BUILD"
      docker_image_name: "library/openjdk"
      docker_image_tag: "11"
      execute_commands:
        - "#Install Android SDK"
        - ""
        - "#Buddy"
        - "export ANDROID_HOME=\"/opt/android/sdk/\""
        - "export PATH=$PATH:/opt/android/sdk/cmdline-tools/tools/bin"
        - "export PATH=$PATH:/opt/gradle/gradle-4.7/bin"
        - "if [ ! -d \"$ANDROID_HOME/cmdline-tools\" ]; then"
        - " curl -o sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip"
        - " unzip sdk.zip"
        - " rm sdk.zip"
        - " mkdir \"$ANDROID_HOME/cmdline-tools\""
        - " mv cmdline-tools \"$ANDROID_HOME/cmdline-tools/tools\""
        - " yes | \"$ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager\" --licenses"
        - "fi"
        - "#Buddy"
        - ""
        - "cd ConceptSound"
        - "npm i --force"
        - "if [ ! -d \"android\" ]; then"
        - " ionic cap add android"
        - "fi"
        - "ionic cap sync android"
      setup_commands:
        - "# install gradle"
        - "apt-get update && apt-get install -y zip"
        - "curl -L -Of https://services.gradle.org/distributions/gradle-4.7-bin.zip"
        - "mkdir /opt/gradle"
        - "unzip -d /opt/gradle gradle-4.7-bin.zip"
        - "# install nodejs"
        - "curl -sL https://deb.nodesource.com/setup_18.x | bash -"
        - "apt-get install -y nodejs"
        - "npm install -g @ionic/cli@latest"
      cached_dirs:
        - "/root/.gradle"
        - "/opt/android/sdk"
      shell: "BASH"
    - action: "set app permissions"
      type: "BUILD"
      docker_image_name: "library/ubuntu"
      docker_image_tag: "20.04"
      execute_commands:
        - "manifest_file=\"./ConceptSound/android/app/src/main/AndroidManifest.xml\""
        - "permissions_file=\"./ConceptSound/build/permissions.xml\""
        - ""
        - "start_line=$(( $(grep -n \"<!-- Permissions -->\" \"$manifest_file\" | cut -d ':' -f 1) + 1 ))"
        - "sed -i \"${start_line},\\$d\" \"$manifest_file\""
        - ""
        - "cat \"$permissions_file\" >> \"$manifest_file\""
        - "echo \"</manifest>\" >> \"$manifest_file\""
      shell: "BASH"
    - action: "set app names"
      type: "BUILD"
      docker_image_name: "library/ubuntu"
      docker_image_tag: "20.04"
      execute_commands:
        - "cp ./ConceptSound/build/names.xml ./ConceptSound/android/app/src/main/res/values/strings.xml"
      shell: "BASH"
    - action: "build android"
      type: "BUILD"
      docker_image_name: "library/openjdk"
      docker_image_tag: "17"
      execute_commands:
        - "export ANDROID_HOME=\"/opt/android/sdk\""
        - "export PATH=$PATH:/opt/android/sdk/cmdline-tools/tools/bin"
        - "if [ ! -d \"$ANDROID_HOME/cmdline-tools\" ]; then"
        - " curl -o sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip"
        - " unzip sdk.zip"
        - " rm sdk.zip"
        - " mkdir \"$ANDROID_HOME/cmdline-tools\""
        - " mv cmdline-tools \"$ANDROID_HOME/cmdline-tools/tools\""
        - " yes | \"$ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager\" --licenses"
        - "fi"
        - "cd ConceptSound/android"
        - "chmod +x gradlew"
        - "#./gradlew assembleDebug"
        - "./gradlew assembleRelease"
      setup_commands:
        - "microdnf install unzip"
        - "microdnf install findutils"
      cached_dirs:
        - "/root/.gradle"
        - "/opt/android/sdk"
      shell: "BASH"
    - action: "copy apk"
      type: "BUILD"
      docker_image_name: "library/ubuntu"
      docker_image_tag: "20.04"
      execute_commands:
        - "cp ./ConceptSound/android/app/build/outputs/apk/release/app-release-unsigned.apk ./ConceptSound.apk"
        - "git add -A"
      setup_commands:
        - "apt-get update && apt-get -y install git"
      shell: "BASH"
    - action: "sign apk"
      type: "BUILD"
      docker_image_name: "library/ubuntu"
      docker_image_tag: "20.04"
      execute_commands:
        - "java -jar /usr/bin/apksigner sign --ks ./ConceptSound/build/app.keystore --ks-pass pass:Qoncept ./ConceptSound.apk"
      setup_commands:
        - "apt-get update && apt-get -y install apksigner"
      shell: "BASH"
    - action: "Push to git@github.com:mjakobsche/PracaDyplomowa.git"
      type: "PUSH"
      git_auth_mode: "ENV_KEY"
      env_key: "secure!AYPe+qrTh41BZCpFcwpojA==.9ovwWyfny9PTyIzu1pjTrA=="
      push_url: "git@github.com:mjakobsche/PracaDyplomowa.git"
      comment: "deployment [ $BUDDY_EXECUTION_ID ]"
